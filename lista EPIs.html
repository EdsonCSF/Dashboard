<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Controle de Entrega de EPIs</title>
    <style>
        :root {
            --cor-primaria: #007bff;
            --cor-sucesso: #5cb85c;
            --cor-aviso: #f0ad4e;
            --cor-erro: #d9534f;
            --verde-claro: #d4edda;
            --vermelho-claro: #f8d7da;
            --cor-edicao: #3498db; /* Azul para edição */
        }

        body {
            font-family: Arial, sans-serif;
            margin: 0;
            background-color: #f4f4f9;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 20px auto;
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            flex-grow: 1;
        }

        h1, h2 {
            color: #333;
            text-align: center;
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .form-group input {
            width: 100%;
            padding: 8px;
            box-sizing: border-box;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        button {
            padding: 10px 15px;
            background-color: var(--cor-sucesso);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: #4cae4c;
        }

        /* --- Formulário de Funcionário (Melhor Responsividade) --- */
        #form-funcionario {
            display: flex;
            flex-wrap: wrap; 
            gap: 20px;
            margin-bottom: 30px;
            padding: 15px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
        
        #form-funcionario > .form-group {
            flex: 1 1 45%; 
            min-width: 250px; 
        }
        
        #btn-abrir-modal-epis {
            background-color: var(--cor-aviso);
            width: 100%;
        }

        #btn-abrir-modal-epis:hover {
             background-color: #e59400;
        }

        #form-funcionario button[type="submit"] {
            flex-basis: 100%; 
        }
        
        /* Botões de Ação na Tabela */
        .btn-edit {
            background-color: var(--cor-edicao);
            margin-right: 5px;
        }
        .btn-edit:hover {
            background-color: #2980b9;
        }

        /* --- Tabela de EPIs Disponíveis (Tags) --- */
        #form-epi-adicional {
            display: grid;
            grid-template-columns: 2fr 1fr; 
            gap: 15px;
            margin-top: 20px;
            margin-bottom: 20px;
            padding: 15px;
            background-color: #e9ecef;
            border-radius: 5px;
        }
        
        #lista-epis-container {
            grid-column: 1 / -1; 
            padding: 10px;
            border: 1px dashed #ccc;
            background-color: #f8f9fa;
        }

        .epi-tag {
            display: inline-flex;
            align-items: center;
            background-color: var(--cor-primaria);
            color: white;
            padding: 3px 8px;
            margin: 3px;
            border-radius: 4px;
            font-size: 0.85em;
        }

        .btn-excluir-epi {
            background: none;
            border: none;
            color: white;
            font-weight: bold;
            margin-left: 5px;
            cursor: pointer;
            padding: 0;
            line-height: 1;
            font-size: 1em;
            opacity: 0.8;
        }
        
        /* --- Tabela de Funcionários --- */
        #tabela-funcionarios {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 0.9em;
        }

        #tabela-funcionarios th, #tabela-funcionarios td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        
        /* Centraliza a quantidade */
        #tabela-funcionarios td:nth-child(n+4) {
             text-align: center;
        }

        #tabela-funcionarios th {
            background-color: var(--cor-primaria);
            color: white;
            position: sticky; 
            top: 0;
            z-index: 10;
        }

        .pegar-epi {
            background-color: var(--verde-claro) !important;
        }

        .nao-pegar-epi {
            background-color: var(--vermelho-claro) !important;
        }

        .btn-status {
            padding: 5px;
            border-radius: 3px;
            font-size: 0.75em;
        }

        .btn-status-pegar {
            background-color: green;
        }

        .btn-status-nao-pegar {
            background-color: red;
        }

        .btn-remover {
            background-color: var(--cor-erro);
        }
        
        /* --- Modal EPIs --- */
        .modal {
            display: none; 
            position: fixed; 
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%; 
            height: 100%; 
            overflow: auto; 
            background-color: rgba(0,0,0,0.4); 
        }

        .modal-content {
            background-color: #fefefe;
            margin: 10% auto; 
            padding: 20px;
            border: 1px solid #888;
            width: 90%; 
            max-width: 600px;
            border-radius: 8px;
            position: relative;
        }

        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }

        .close-button:hover,
        .close-button:focus {
            color: #000;
            text-decoration: none;
            cursor: pointer;
        }
        
        #lista-modal-epis {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            margin-bottom: 15px;
        }
        
        .epi-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px dotted #eee;
        }
        
        .epi-item:last-child {
            border-bottom: none;
        }
        
        .epi-item input[type="number"] {
            width: 60px;
            text-align: center;
        }

        /* --- Rodapé de Créditos --- */
        .developer-credits {
            background-color: #333;
            color: #fff;
            padding: 15px;
            text-align: center;
            font-size: 0.9em;
            margin-top: 20px;
        }

        .developer-credits h3 {
            margin-top: 0;
            font-size: 1.2em;
        }

        .developer-credits a {
            color: var(--vermelho-claro); 
            text-decoration: none;
        }
        
        /* --- Responsividade Geral --- */
        @media (max-width: 600px) {
            .container {
                margin: 10px;
                padding: 10px;
            }
            .table-container {
                overflow-x: auto; 
            }
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>Controle de Entrega de EPIs</h1>

        <h2>Adicionar/Excluir EPI</h2>
        <form id="form-epi-adicional">
            <div class="form-group">
                <label for="nome-novo-epi">Nome do EPI:</label>
                <input type="text" id="nome-novo-epi" placeholder="Ex: Luva de Raspa" required>
            </div>
            <div class="form-group">
                <button type="submit">Adicionar EPI à Lista</button>
            </div>
            <div id="lista-epis-container">
                <strong>EPIs Disponíveis:</strong> <div id="lista-epis-tags"></div>
            </div>
        </form>

        <h2>Cadastrar Funcionário e EPIs</h2>
        <form id="form-funcionario">
            <input type="hidden" id="edit-index" value="-1"> 
            
            <div class="form-group">
                <label for="nome">Nome do Funcionário:</label>
                <input type="text" id="nome" required>
            </div>
            <div class="form-group">
                <label for="drt">DRT (Número):</label>
                <input type="text" id="drt" required>
            </div>
            
            <div class="form-group" style="flex: 1 1 100%;">
                <label>EPIs Selecionados (Clique para Adicionar/Editar):</label>
                <button type="button" id="btn-abrir-modal-epis" onclick="abrirModalEpis()">Selecionar EPIs e Quantidades</button>
                <p style="margin-top: 5px; font-size: 0.9em;">*Quantidade de EPIs selecionadas: <span id="qtd-epis-selecionados">0</span></p>
            </div>

            <button type="submit" id="btn-submit">Adicionar Funcionário</button>
            <button type="button" id="btn-cancelar" style="background-color: var(--cor-erro); display: none;" onclick="cancelarEdicao()">Cancelar Edição</button>
        </form>

        <h2>Lista de Funcionários</h2>
        <div class="table-container" style="overflow-x: auto;">
            <table id="tabela-funcionarios">
                <thead>
                    <tr>
                        <th>DRT</th>
                        <th>Nome</th>
                        <th>Status (Pegar/Não Pegar)</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody>
                    </tbody>
            </table>
        </div>
    </div>
    
    <div id="modalEpis" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="fecharModalEpis()">&times;</span>
            <h2>Selecione os EPIs e a Quantidade</h2>
            <p>Digite a quantidade necessária para cada EPI. Deixe em branco (limpo) para não incluir.</p>
            <div id="lista-modal-epis">
                </div>
            <button type="button" onclick="salvarEpisDoModal()">Salvar Seleção de EPIs</button>
        </div>
    </div>

    <div class="developer-credits">
        <h3>Desenvolvedor</h3>
        <p>Desenvolvido por EdsonC.S.F.</p>
        <p>Contato: <a href="mailto:edsony1@gmail.com">edsony1@gmail.com</a></p>
        <p>Criação: Outubro de 2025</p>
        <p>Versão: 1.0 &copy; 2025. Todos os direitos reservados.</p>
    </div>

    <script>
        const STORAGE_KEY_FUNCIONARIOS = 'episFuncionarioData';
        const STORAGE_KEY_EPIS = 'episDisponiveis';

        let episDisponiveis = [
            'Protetor Auricular',
            'Luvas Finas',
            'Mangote',
            'Óculos',
            'Capacete',
            'Bota',
            'Palmilha',
            'Carneira'
        ];

        let funcionarios = [];
        let episTemporarios = {}; 

        // --- Funções de Armazenamento Local (LocalStorage) ---

        function carregarDados() {
            const storedEpis = localStorage.getItem(STORAGE_KEY_EPIS);
            if (storedEpis) {
                episDisponiveis = JSON.parse(storedEpis);
            }

            const storedFuncionarios = localStorage.getItem(STORAGE_KEY_FUNCIONARIOS);
            if (storedFuncionarios) {
                funcionarios = JSON.parse(storedFuncionarios);
            }
            
            // Corrige dados antigos para garantir que todos os EPIs globais existam
            funcionarios.forEach(func => {
                const novosEpis = {};
                episDisponiveis.forEach(epi => {
                    novosEpis[epi] = func.epis[epi] || 0; 
                });
                func.epis = novosEpis;
            });
            salvarFuncionarios(); 

            // Inicializa episTemporarios
            inicializarEpisTemporarios();
        }

        function salvarFuncionarios() {
            localStorage.setItem(STORAGE_KEY_FUNCIONARIOS, JSON.stringify(funcionarios));
        }

        function salvarEpis() {
            localStorage.setItem(STORAGE_KEY_EPIS, JSON.stringify(episDisponiveis));
        }
        
        // --- Controle do Formulário e Edição ---
        
        function inicializarEpisTemporarios(episData = {}) {
            episTemporarios = {};
            let count = 0;
            episDisponiveis.forEach(epi => {
                const qtd = episData[epi] || 0;
                episTemporarios[epi] = qtd;
                if (qtd > 0) count++;
            });
            document.getElementById('qtd-epis-selecionados').textContent = count;
        }

        function preencherFormulario(funcionario, index) {
            document.getElementById('nome').value = funcionario.nome;
            document.getElementById('drt').value = funcionario.drt;
            document.getElementById('edit-index').value = index;
            document.getElementById('btn-submit').textContent = 'Salvar Edição';
            document.getElementById('btn-submit').style.backgroundColor = 'var(--cor-edicao)';
            document.getElementById('btn-cancelar').style.display = 'inline-block';
            
            // Carrega os dados de EPIs para o objeto temporário
            inicializarEpisTemporarios(funcionario.epis);
        }

        function limparFormulario() {
            document.getElementById('form-funcionario').reset();
            document.getElementById('edit-index').value = -1;
            document.getElementById('btn-submit').textContent = 'Adicionar Funcionário';
            document.getElementById('btn-submit').style.backgroundColor = 'var(--cor-sucesso)';
            document.getElementById('btn-cancelar').style.display = 'none';
            inicializarEpisTemporarios();
        }
        
        function cancelarEdicao() {
            limparFormulario();
        }

        // --- Funções do Modal ---
        
        function abrirModalEpis(funcionarioEpis = null) {
            const modal = document.getElementById('modalEpis');
            const listaModal = document.getElementById('lista-modal-epis');
            listaModal.innerHTML = ''; 
            
            // Se estiver reabrindo o modal, o episTemporarios já tem os valores.
            // Se for a primeira vez (ou novo cadastro), usamos a função inicializarEpisTemporarios()
            
            episDisponiveis.forEach(epi => {
                const qtd = episTemporarios[epi] || ''; 
                
                // CRUCIAL: Se a QTD for 0, usamos '' (string vazia) para melhor usabilidade
                const displayQtd = (qtd === 0) ? '' : qtd;

                const html = `
                    <div class="epi-item">
                        <span>${epi}:</span>
                        <input type="number" id="modal-qtd-${epi.replace(/\s/g, '_')}" 
                               min="0" step="1" value="${displayQtd}" oninput="atualizarEpiTemporario('${epi}', this.value)">
                    </div>
                `;
                listaModal.insertAdjacentHTML('beforeend', html);
            });

            modal.style.display = 'block';
        }
        
        function fecharModalEpis() {
            document.getElementById('modalEpis').style.display = 'none';
        }
        
        function atualizarEpiTemporario(epiNome, valor) {
            // Se o valor for uma string vazia, trata como 0 para salvar
            const qtd = Math.max(0, parseInt(valor) || 0); 
            episTemporarios[epiNome] = qtd;
        }

        function salvarEpisDoModal() {
            // Conta quantos EPIs têm quantidade > 0
            const qtdSelecionados = Object.values(episTemporarios).filter(qtd => qtd > 0).length;
            document.getElementById('qtd-epis-selecionados').textContent = qtdSelecionados;
            
            fecharModalEpis();
        }

        // --- Funções de Renderização e Lógica do Sistema ---

        function renderizarListaEpisTags() {
            const listaTagsDiv = document.getElementById('lista-epis-tags');
            listaTagsDiv.innerHTML = '';

            episDisponiveis.forEach(epi => {
                const tagHtml = `
                    <span class="epi-tag">
                        ${epi} 
                        <button class="btn-excluir-epi" type="button" onclick="excluirEPI('${epi}')" title="Excluir EPI">x</button>
                    </span>
                `;
                listaTagsDiv.insertAdjacentHTML('beforeend', tagHtml);
            });
        }

        function renderizarTabela() {
            const tbody = document.querySelector('#tabela-funcionarios tbody');
            const theadTr = document.querySelector('#tabela-funcionarios thead tr');
            tbody.innerHTML = ''; 

            // 1. Recria o cabeçalho
            theadTr.innerHTML = `
                <th>DRT</th>
                <th>Nome</th>
                <th>Status (Pegar/Não Pegar)</th>
            `;
            episDisponiveis.forEach(epi => {
                theadTr.insertAdjacentHTML('beforeend', `<th data-epi-name="${epi}">${epi} (Qtd)</th>`);
            });
            theadTr.insertAdjacentHTML('beforeend', `<th>Ações</th>`);

            // 2. Preenche as linhas dos funcionários
            funcionarios.forEach((funcionario, index) => {
                const tr = document.createElement('tr');

                if (funcionario.status === 'pegar') {
                    tr.classList.add('pegar-epi');
                } else if (funcionario.status === 'nao-pegar') {
                    tr.classList.add('nao-pegar-epi');
                }

                let rowHtml = `
                    <td data-label="DRT">${funcionario.drt}</td>
                    <td data-label="Nome">${funcionario.nome}</td>
                    <td data-label="Status">
                        <button class="btn-status btn-status-pegar" onclick="trocarStatus(${index}, 'pegar')">VERDE</button>
                        <button class="btn-status btn-status-nao-pegar" onclick="trocarStatus(${index}, 'nao-pegar')">VERMELHO</button>
                    </td>
                `;

                // Adiciona as colunas de quantidade de EPIs
                episDisponiveis.forEach(epi => {
                    // Pega o valor do EPI, se não existir, usa 0
                    const qtd = funcionario.epis[epi] || 0; 
                    
                    // Lógica para remover os 0s da exibição na tabela
                    const displayQtd = (qtd > 0) ? qtd : ''; 
                    
                    rowHtml += `<td data-label="${epi} (Qtd)">${displayQtd}</td>`;
                });

                rowHtml += `
                    <td data-label="Ações">
                        <button class="btn-edit btn-status" onclick="editarFuncionario(${index})">Editar</button>
                        <button class="btn-remover" onclick="removerFuncionario(${index})">Remover</button>
                    </td>
                `;

                tr.innerHTML = rowHtml;
                tbody.appendChild(tr);
            });
        }

        // --- Funções de Ação (Adicionar, Editar, Excluir, Status) ---

        function adicionarFuncionario(event) {
            event.preventDefault();

            const nome = document.getElementById('nome').value.trim();
            const drt = document.getElementById('drt').value.trim();
            const editIndex = parseInt(document.getElementById('edit-index').value);
            
            if (!nome || !drt) {
                alert("Por favor, preencha o Nome e o DRT do funcionário.");
                return;
            }

            // Cria o objeto de EPIs com base nos temporários (apenas QTD > 0)
            let episFinais = {};
            episDisponiveis.forEach(epi => {
                 const qtd = episTemporarios[epi] || 0;
                 if (qtd > 0) {
                     episFinais[epi] = qtd;
                 }
            });

            const dadosFuncionario = {
                nome: nome,
                drt: drt,
                epis: episFinais,
                status: (editIndex === -1) ? 'nao-pegar' : funcionarios[editIndex].status // Mantém status se for edição
            };

            if (editIndex === -1) {
                // Modo Adicionar
                funcionarios.push(dadosFuncionario);
            } else {
                // Modo Editar
                funcionarios[editIndex] = dadosFuncionario;
            }

            salvarFuncionarios();
            renderizarTabela();
            limparFormulario();
        }
        
        function editarFuncionario(index) {
            const funcionario = funcionarios[index];
            preencherFormulario(funcionario, index);
            
            // Abre o modal após carregar os dados
            // O modal será aberto com os dados do funcionário carregados em episTemporarios
            // não é necessário chamá-lo aqui, pois o objeto já está pronto.
            
            // Se quiser que o modal abra automaticamente ao clicar em Editar:
            // abrirModalEpis();
        }

        function adicionarNovoEPI(event) {
            event.preventDefault();
            const novoEpiInput = document.getElementById('nome-novo-epi');
            const novoEpiNome = novoEpiInput.value.trim();

            if (novoEpiNome && !episDisponiveis.includes(novoEpiNome)) {
                episDisponiveis.push(novoEpiNome);
                salvarEpis();
                
                // Atualiza os registros dos funcionários existentes com 0 para o novo EPI
                funcionarios.forEach(func => {
                    func.epis[novoEpiNome] = 0;
                });
                salvarFuncionarios();
                
                renderizarListaEpisTags();
                renderizarTabela(); 
                inicializarEpisTemporarios(); // Adiciona o novo EPI na lista do modal/temporários

                novoEpiInput.value = '';
            } else {
                alert('Nome do EPI inválido ou já existente.');
            }
        }
        
        function excluirEPI(epiNome) {
            if (confirm(`Tem certeza que deseja excluir o EPI: "${epiNome}"? Isso removerá a coluna da tabela e apagará os dados deste EPI em todos os funcionários.`)) {
                
                episDisponiveis = episDisponiveis.filter(epi => epi !== epiNome);
                salvarEpis();

                funcionarios.forEach(func => {
                    delete func.epis[epiNome];
                });
                salvarFuncionarios();
                
                renderizarListaEpisTags();
                renderizarTabela();
                inicializarEpisTemporarios(); 
            }
        }

        function trocarStatus(index, novoStatus) {
            funcionarios[index].status = novoStatus;
            salvarFuncionarios();
            renderizarTabela();
        }

        function removerFuncionario(index) {
            if (confirm('Tem certeza que deseja remover este funcionário?')) {
                funcionarios.splice(index, 1);
                salvarFuncionarios();
                renderizarTabela();
            }
        }

        // --- Inicialização ---

        document.addEventListener('DOMContentLoaded', () => {
            carregarDados();
            renderizarListaEpisTags();
            renderizarTabela();
            
            document.getElementById('form-funcionario').addEventListener('submit', adicionarFuncionario);

            // Adiciona listener para fechar o modal clicando fora
            window.onclick = function(event) {
                const modal = document.getElementById('modalEpis');
                if (event.target == modal) {
                    fecharModalEpis();
                }
            }
        });

    </script>

</body>
</html>
